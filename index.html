<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>舗装補修計算ツール</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: 'San Francisco', 'SF Pro Display', 'Segoe UI', 'Meiryo', sans-serif;
      background: linear-gradient(135deg, #f6f6f7 0%, #eaeef3 100%);
      margin: 0;
      color: #222;
    }
    .container {
      max-width: 900px;
      margin: 32px auto;
      padding: 28px 12px 38px 12px;
      background: #fff;
      border-radius: 28px;
      box-shadow: 0 6px 36px #0001, 0 1.5px 8px #7e7e7e11;
      border: 1.5px solid #ececec;
    }
    .tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 20px;
      overflow-x: auto;
      flex-wrap: nowrap;
      -webkit-overflow-scrolling: touch;
      background: #f5f6fa;
      border-radius: 14px 14px 0 0;
      box-shadow: 0 2.5px 10px #a4b4d922;
      padding-left: 2px;
    }
    .tab {
      padding: 10px 32px;
      background: transparent;
      border-radius: 13px 13px 0 0;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.05em;
      color: #2980fe;
      border: none;
      border-bottom: 2.5px solid transparent;
      transition: all 0.14s cubic-bezier(.48,.01,.6,1.01);
      letter-spacing: 0.04em;
      display: flex;
      align-items: center;
    }
    .tab.active, .tab:hover {
      background: #e3ebfa;
      color: #007aff;
      border-bottom: 3px solid #007aff;
      box-shadow: 0 3px 14px #007aff14;
      font-weight: 700;
    }
    input, select {
      padding: 9px 10px;
      font-size: 1.01em;
      border: 1.3px solid #d2d4dc;
      border-radius: 11px;
      background: #f8fafd;
      box-shadow: 0 2.5px 12px #eef2fb13 inset;
      outline: none;
      transition: border 0.18s, box-shadow 0.17s;
      max-width: 120px;
      box-sizing: border-box;
      margin-bottom: 3px;
    }
    .siteName { max-width: 190px; }
    input:focus, select:focus {
      border: 1.7px solid #007aff;
      background: #f3faff;
      box-shadow: 0 0 0 2px #007aff15;
    }
    input[readonly], .readonly {
      background: #f4f4f7 !important;
      color: #bbb;
      pointer-events: none;
    }
    .btn {
      padding: 8px 22px;
      background: linear-gradient(180deg,#007aff 0%,#005ed6 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      margin-right: 12px;
      box-shadow: 0 2px 8px #007aff15, 0 1.5px 3px #4d8fff08;
      transition: background 0.18s, box-shadow 0.17s;
      letter-spacing: 0.01em;
    }
    .btn:hover { background: #005ed6; }
    .btn:active { box-shadow: 0 0px 2px #007aff14; background: #297aff; }
    .block {
      margin: 14px 0 24px 0;
      padding: 22px 12px 16px 12px;
      background: #f9fafb;
      border-radius: 17px;
      box-shadow: 0 1.5px 8px #007aff09;
      border: 1px solid #eef0f5;
      overflow-x: auto;
    }
    .block label {
      font-weight: 500;
      margin-right: 10px;
      color: #445;
      letter-spacing: 0.01em;
    }
    h4 {
      font-size: 1.18em;
      color: #007aff;
      margin-bottom: 0.5em;
      margin-top: 0.3em;
      font-weight: 700;
      letter-spacing: 0.02em;
    }
    table, .ss-table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      margin-top: 13px;
      background: #fff;
      box-shadow: 0 2px 18px #4c8bfd09;
      border-radius: 11px;
      overflow: hidden;
      min-width: 700px;
      font-size: 1em;
      border: 1px solid #f3f4fa;
    }
    th, td, .ss-table th, .ss-table td {
      border-bottom: 1.5px solid #e9eefa;
      padding: 10px 7px;
      text-align: center;
      white-space: nowrap;
      font-size: 0.99em;
    }
    th, .ss-table th {
      background: #f4f7fd;
      color: #007aff;
      font-weight: bold;
      border-top: none;
      font-size: 1.04em;
    }
    tr:last-child td { border-bottom: none; }
    .ss-table {
      margin-top: 13px;
      background: #fff;
      border-radius: 13px;
      border: 1.5px solid #e6eef5;
      min-width: 950px;
      width: auto;
      display: inline-block;
      font-size: 1.01em;
    }
    .ss-table th, .ss-table td {
      border-right: 1.5px solid #eaeaea;
    }
    .ss-table tr td:last-child, .ss-table tr th:last-child { border-right: none; }
    .ss-table tr:last-child td { border-bottom: none; }
    .sum {
      margin-top: 14px;
      font-weight: 600;
      color: #007aff;
      font-size: 1.17em;
      letter-spacing: 0.5px;
    }
    .hidden { display: none;}
    .alert { color: #e12b43; font-weight: bold;}
    .works-setting { margin-left: 22px; margin-top: 7px; margin-bottom: 10px; }
    .scroll-x-guide {
      text-align: right;
      color: #aaa;
      font-size: 0.94em;
      padding: 0 4px 0 0;
    }
    @media (max-width: 900px) {
      .container {padding: 5px;}
      .block {padding: 8px;}
      table, .ss-table {font-size: 13px;}
      input, select { font-size: 0.97em; }
      .ss-table { min-width: 600px; }
    }
    @media (max-width: 600px) {
      .container { width: 100%; max-width: none; margin: 10px 0; padding: 4px; }
      .block { margin: 10px 0; padding: 8px 3px; }
      table, .ss-table { width: 100%; min-width: 0; display: block; font-size: 12px; overflow-x:scroll;}
      input, select { padding: 5px 4px; }
      .siteName { width: 100%; max-width: none; }
      input[type="number"] { width: 50px; }
    }
  </style>
</head>
<body>
<div class="container">

  <div class="block" style="margin-bottom:26px">
    <label>現場名:</label>
    <input id="siteName" class="siteName" placeholder="例：〇〇号線" style="width:170px;">
    <button class="btn" onclick="addSite()">追加</button>
    <select id="siteList" onchange="switchSite()" style="margin-left:12px;"></select>
  </div>

  <!-- タブ（動的生成） -->
  <div class="tabs" id="tabsArea"></div>

  <!-- 工種設定タブ -->
  <div id="panelWorks" class="block">
    <h4>工種設定</h4>
    <div>
      <label><input type="checkbox" id="chkWorksEarth" onchange="renderTabs()"> 土工</label>
      <div id="worksEarthSetting" class="works-setting hidden">
        <label><input type="checkbox" id="earthSamePave" onchange="saveAndUpdate()"> 舗装面積と同じ</label>
        <select id="earthType" onchange="saveAndUpdate()">
          <option>標準掘削</option>
          <option>標準以下掘削</option>
        </select>
        <label>掘削厚（cm）：<input type="number" id="earthThick" min="0" style="width:60px;" onchange="saveAndUpdate()"></label>
      </div>
    </div>
    <div>
      <label><input type="checkbox" id="chkWorksDemo" onchange="renderTabs()"> 取り壊し工</label>
      <div id="worksDemoSetting" class="works-setting hidden">
        <label><input type="checkbox" id="demoSamePave" onchange="saveAndUpdate()"> 舗装面積と同じ</label>
        <select id="demoType" onchange="saveAndUpdate()">
          <option>As</option>
          <option>Con</option>
          <option>As+Con</option>
        </select>
        <label>取壊し厚（cm）：<input type="number" id="demoThick" min="0" style="width:60px;" onchange="saveAndUpdate()"></label>
      </div>
    </div>
    <div>
      <label><input type="checkbox" id="chkWorksAnzen" onchange="renderTabs()"> 安全施設工</label>
      <div id="worksAnzenSetting" class="works-setting hidden"></div>
    </div>
    <div>
      <label><input type="checkbox" id="chkWorksKari" onchange="renderTabs()"> 仮設工</label>
      <div id="worksKariSetting" class="works-setting hidden"></div>   
    </div>
    <div>
      <label><input type="checkbox" id="chkWorksZatsu" onchange="renderTabs()"> 雑工</label>
    </div>
  </div>

  <!-- 土工タブ -->
  <div id="panelEarth" class="block hidden">
    <h4>土工（体積計算）</h4>
    <div id="earthResult"></div>
  </div>
  <!-- 舗装工タブ -->
  <div id="panelPave" class="block hidden">
    <h4>舗装工</h4>
    <button class="btn" onclick="addRow('pave')">行追加</button>
    <button class="btn" onclick="exportDXF()">DXFエクスポート</button>
    <div style="overflow-x:auto;">
      <div class="scroll-x-guide">(横スクロール可)</div>
      <table>
        <thead>
          <tr>
            <th>種別</th>
            <th>測点</th>
            <th>単距</th>
            <th>追距</th>
            <th>幅員</th>
            <th>平均幅員</th>
            <th>面積</th>
          </tr>
        </thead>
        <tbody id="tbodyPave"></tbody>
      </table>
    </div>
    <div class="sum" id="sumPave"></div>
  </div>
  <!-- 取り壊し工タブ -->
  <div id="panelDemo" class="block hidden">
    <h4>取り壊し工</h4>
    <div id="demoResult"></div>
  </div>
  <!-- 安全施設工タブ -->
  <div id="panelAnzen" class="block hidden">
    <h4>安全施設工</h4>
    <div>
      <label>区画線設置 外側線：<input type="number" id="anzenOutside" min="0" onchange="editAnzen('outside', this.value)"></label>
    </div>
    <div>
      <label>区画線設置 停止線：<input type="number" id="anzenStop" min="0" onchange="editAnzen('stop', this.value)"></label>
    </div>
    <div>
      <label>区画線設置 文字記号：<input type="number" id="anzenMark" min="0" onchange="editAnzen('mark', this.value)"></label>
    </div>
  </div>
  <!-- 仮設工タブ -->
  <div id="panelKari" class="block hidden">
    <h4>仮設工</h4>
    <div>
      <label>交通誘導員B：<input type="number" id="kariGuideB" min="0" onchange="editKari('guideB', this.value)"></label>
    </div>
    <div>
      <label>仮設信号機：<input type="number" id="kariSignal" min="0" onchange="editKari('signal', this.value)"></label>
    </div>
    <div>
      <label>重機運搬費：<input type="number" id="kariTransport" min="0" onchange="editKari('transport', this.value)"></label>
    </div>
  </div>
  <!-- 免責事項タブ -->
  <div id="panelDisclaimer" class="block hidden">
    <p>
      本Webアプリは無保証で提供しています。利用による一切の損害について、作者は責任を負いません。<br>
      業務・商用利用の際は必ずご自身で検証し利用を検討してください。<br>
      <b>出力データ（DXF等）は参考用です。必ず自己責任でご利用ください。</b>
    </p>
  </div>
  <div class="block">
    <button class="btn" onclick="showSummary()">全施工箇所合計表示</button>
    <div style="overflow-x:auto;">
      <div id="summary"></div>
    </div>
  </div>
  <div id="fatalAlert" class="alert hidden"></div>

<script>
// ▼ グローバル定義
const CHK_KEY = 'paveWorksChecks_v1';
const LS_KEY = 'paveAppAllSites_v6'; // 新バージョンに合わせて更新
// 過去バージョンの保存キー一覧（最も古いものから順）
const OLD_KEYS = ['paveAppAllSites_v5', 'paveAppAllSites_v4', 'paveAppAllSites_v3', 'paveAppAllSites_v2', 'paveAppAllSites'];

// --- LocalStorage Migration ---
// 以前のバージョンで使用していたキーが存在する場合、
// データを新しいキーに移し替え、旧キーを削除する
function migrateOldData() {
  for (const k of OLD_KEYS) {
    const oldStr = localStorage.getItem(k);
    if (!oldStr) continue;
    try {
      const dat = JSON.parse(oldStr);
      if (dat && typeof dat === 'object') {
        localStorage.setItem(LS_KEY, JSON.stringify(dat));
        localStorage.removeItem(k);
        break; // 1つ見つけたらそれを採用
      }
    } catch(e) {
      // parse error -> ignore
    }
    localStorage.removeItem(k);
  }
}
let allSites = {};
let currentSite = '';
const paveTypes = ["アスファルト", "コンクリート", "オーバーレイ"];
const worksList = [
  { id: "Works", label: "工種設定", always: true, panel: "panelWorks" },
  { id: "Earth", label: "土工", chk: "chkWorksEarth", setting: "worksEarthSetting", panel: "panelEarth" },
  { id: "Pave", label: "舗装工", always: true, panel: "panelPave" },
  { id: "Demo", label: "取り壊し工", chk: "chkWorksDemo", setting: "worksDemoSetting", panel: "panelDemo" },
  { id: "Anzen", label: "安全施設工", chk: "chkWorksAnzen", setting: "worksAnzenSetting", panel: "panelAnzen" },
  { id: "Kari", label: "仮設工", chk: "chkWorksKari", setting: "worksKariSetting", panel: "panelKari" },
  { id: "Zatsu", label: "雑工", chk: "chkWorksZatsu", panel: null },
  { id: "Disclaimer", label: "免責事項", always: true, panel: "panelDisclaimer"}
];

// ▼ タブUI生成＆切り替え
function renderTabs() {
  let tabHtml = '';
  for(const w of worksList) {
    if(w.always || document.getElementById(w.chk)?.checked) {
      tabHtml += `<div class="tab" id="tab${w.id}" onclick="showTab('${w.id}')">${w.label}</div>`;
    }
    if(w.setting) {
      const settingDiv = document.getElementById(w.setting);
      if(settingDiv)
        document.getElementById(w.chk).checked ? settingDiv.classList.remove('hidden') : settingDiv.classList.add('hidden');
    }
    if(w.panel && w.chk) {
      document.getElementById(w.panel).classList[document.getElementById(w.chk).checked ? "remove" : "add"]('hidden');
    }
  }
  document.getElementById('tabsArea').innerHTML = tabHtml;
  const firstActive = worksList.find(w => w.always || document.getElementById(w.chk)?.checked);
  if(firstActive) showTab(firstActive.id);
  saveCheckStates();
  saveAndUpdate();
}
function showTab(tabId) {
  for(const w of worksList) {
    document.getElementById('tab'+w.id)?.classList.remove('active');
    if(w.panel) document.getElementById(w.panel).classList.add('hidden');
  }
  document.getElementById('tab'+tabId)?.classList.add('active');
  worksList.forEach(w => {
    if(w.id === tabId && w.panel) document.getElementById(w.panel).classList.remove('hidden');
  });
}
function saveCheckStates() {
  try {
    const states = {};
    worksList.forEach(w => {
      if(w.chk) states[w.chk] = document.getElementById(w.chk).checked;
    });
    localStorage.setItem(CHK_KEY, JSON.stringify(states));
  } catch(e) {}
}

function loadCheckStates() {
  try {
    const states = JSON.parse(localStorage.getItem(CHK_KEY));
    if(states && typeof states === 'object') {
      worksList.forEach(w => {
        if(w.chk && states.hasOwnProperty(w.chk)) {
          document.getElementById(w.chk).checked = states[w.chk];
        }
      });
    }
  } catch(e) {}
}

// ▼ データ保存・復元
function saveData() {
  try { localStorage.setItem(LS_KEY, JSON.stringify(allSites)); } catch(e) {}
}
function loadData() {
  try {
    const dat = JSON.parse(localStorage.getItem(LS_KEY));
    if (dat && typeof dat === "object") {
      allSites = dat;
      Object.keys(allSites).forEach(s => {
        allSites[s].anzen = allSites[s].anzen || { outside:'', stop:'', mark:'' };
        allSites[s].kari = allSites[s].kari || { guideB:'', signal:'', transport:'' };
      });
      // サイトリスト描画
      const siteList = Object.keys(allSites);
      if (siteList.length) {
        currentSite = siteList[0];
        let opt = '';
        for (const s of siteList) opt += `<option>${s}</option>`;
        document.getElementById('siteList').innerHTML = opt;
        document.getElementById('siteList').value = currentSite;
      }
    }
  } catch(e){}
}
function renderAllAndSave() {
  renderAll();
  saveData();
}
function addSite() {
  const name = document.getElementById('siteName').value.trim();
  if (!name || allSites[name]) return;
  allSites[name] = {
    pave: [],
    earth: [],
    demo: [],
    anzen: { outside:'', stop:'', mark:'' },
    kari: { guideB:'', signal:'', transport:'' },
    earthSetting: { same: true, type: '標準掘削', thick: 0 },
    demoSetting: { same: true, type: 'As', thick: 0 }
  };
  document.getElementById('siteList').innerHTML += `<option>${name}</option>`;
  document.getElementById('siteList').value = name;
  currentSite = name;
  renderAllAndSave();
}
function switchSite() {
  currentSite = document.getElementById('siteList').value;
  renderAllAndSave();
}

// ▼ 各工種設定値を工種設定タブから取得
function getEarthSetting() {
  return {
    same: document.getElementById('earthSamePave').checked,
    type: document.getElementById('earthType').value,
    thick: parseFloat(document.getElementById('earthThick').value)||0
  };
}
function getDemoSetting() {
  return {
    same: document.getElementById('demoSamePave').checked,
    type: document.getElementById('demoType').value,
    thick: parseFloat(document.getElementById('demoThick').value)||0
  };
}

// ▼ 舗装工タブ
function addRow(type) {
  if (!currentSite) return;
  if(type==='pave'){
    allSites[currentSite][type].push({
      種別: "アスファルト", 測点:'',単距:'',追距:'',幅員:'',平均幅員:'',面積:''
    });
  }else{
    allSites[currentSite][type].push({測点:'',単距:'',追距:'',幅員:'',平均幅員:'',面積:''});
  }
  renderAllAndSave();
}
function editRow(type, idx, key, val) {
  if (type === "pave" && key === "種別") {
    for (let i = idx; i < allSites[currentSite][type].length; i++) {
      allSites[currentSite][type][i][key] = val;
    }
  } else {
    allSites[currentSite][type][idx][key] = val;
  }
function editAnzen(key, val) {
  if (!currentSite) return;
  allSites[currentSite].anzen[key] = val;
  renderAllAndSave();
}
function editKari(key, val) {
  if (!currentSite) return;
  allSites[currentSite].kari[key] = val;
  renderAllAndSave();
}
  renderAllAndSave();
}
function renderTablePave() {
  if(!currentSite) return;
  const list = allSites[currentSite].pave;
  let widthSum = 0, cnt = 0;
  list.forEach(r => {
    const w = parseFloat(r.幅員);
    if (!isNaN(w)) {
      widthSum += w;
      cnt++;
    }
  });
  let avgW = cnt ? widthSum / cnt : 0;
  let label = "";
  if (avgW < 1.4) label = "1.4未満";
  else if (avgW < 3.0) label = "1.4以上";
  else label = "3.0以上";
  for(let i=0;i<list.length;i++) {
    let r = list[i];
    r.追距 = (i===0) ? (parseFloat(r.単距)||0)
      : ((parseFloat(list[i-1].追距)||0)+(parseFloat(r.単距)||0));
    r.平均幅員 = label;
    r._平均幅員値 = avgW;
    if (i === 0) {
      r.面積 = (r.単距 && r.幅員) ? (parseFloat(r.単距)*parseFloat(r.幅員)).toFixed(2) : '';
    } else {
      let 上幅員 = parseFloat(list[i-1].幅員)||0;
      let 幅員 = parseFloat(r.幅員)||0;
      let 単距 = parseFloat(r.単距)||0;
      if (幅員 > 0 && 上幅員 > 0 && 単距 > 0) {
        r.面積 = (((幅員 + 上幅員)/2)*単距).toFixed(2);
      } else {
        r.面積 = '';
      }
    }
  }
  let tbody = '';
  list.forEach((r,idx)=>{
    tbody += `<tr>
      <td>
        <select onchange="editRow('pave',${idx},'種別',this.value)">
          ${paveTypes.map(tp=>`<option value="${tp}"${r.種別===tp?' selected':''}>${tp}</option>`).join('')}
        </select>
      </td>
      <td><input value="${r.測点||''}" onchange="editRow('pave',${idx},'測点',this.value)"></td>
      <td><input value="${r.単距||''}" onchange="editRow('pave',${idx},'単距',this.value)"></td>
      <td><input value="${r.追距||''}" class="readonly" readonly></td>
      <td><input value="${r.幅員||''}" onchange="editRow('pave',${idx},'幅員',this.value)"></td>
      <td><input value="${r.平均幅員||''}" class="readonly" readonly></td>
      <td><input value="${r.面積||''}" class="readonly" readonly></td>
    </tr>`;
  });
  document.getElementById('tbodyPave').innerHTML = tbody;
  let sum = {アスファルト:0, コンクリート:0, オーバーレイ:0};
  list.forEach(r=>{
    if(!isNaN(parseFloat(r.面積))){
      sum[r.種別] += parseFloat(r.面積);
    }
  });
  document.getElementById('sumPave').innerHTML =
    `<table class="ss-table">
      <tr>
        <th>現場名</th>
        <th>アスファルト合計</th>
        <th>コンクリート合計</th>
        <th>オーバーレイ合計</th>
      </tr>
      <tr>
        <td>${currentSite}</td>
        <td>${sum.アスファルト.toFixed(2)}</td>
        <td>${sum.コンクリート.toFixed(2)}</td>
        <td>${sum.オーバーレイ.toFixed(2)}</td>
      </tr>
    </table>`;
}

// ▼ 土工集計
function renderEarthResult() {
  if(!currentSite) return;
  const setting = getEarthSetting();
  const paveSum = (allSites[currentSite].pave||[]).reduce((a,r)=>a+(parseFloat(r.面積)||0),0);
  let html = '';
  if(setting.same) {
    const vol = (paveSum * setting.thick / 100).toFixed(2);
    html = `<div>合計体積：${vol} m³　（面積：${paveSum.toFixed(2)}㎡ × 厚さ：${setting.thick}cm）</div>`;
  } else {
    html = `<div style="color:#888;">（現状「舗装面積と同じ」時のみ自動計算です）</div>`;
  }
  document.getElementById('earthResult').innerHTML = html;
}
// ▼ 取壊し工集計
function renderDemoResult() {
  if(!currentSite) return;
  const setting = getDemoSetting();
  const paveSum = (allSites[currentSite].pave||[]).reduce((a,r)=>a+(parseFloat(r.面積)||0),0);
  let html = '';
  if(setting.same) {
    const vol = (paveSum * setting.thick / 100).toFixed(2);
    html = `<div>合計体積：${vol} m³　（面積：${paveSum.toFixed(2)}㎡ × 厚さ：${setting.thick}cm）</div>`;
  } else {
    html = `<div style="color:#888;">（現状「舗装面積と同じ」時のみ自動計算です）</div>`;
  }
  document.getElementById('demoResult').innerHTML = html;
}

function renderAnzen() {
  if(!currentSite) return;
  const a = allSites[currentSite].anzen || {};
  document.getElementById('anzenOutside').value = a.outside || '';
  document.getElementById('anzenStop').value = a.stop || '';
  document.getElementById('anzenMark').value = a.mark || '';
}

function renderKari() {
  if(!currentSite) return;
  const k = allSites[currentSite].kari || {};
  document.getElementById('kariGuideB').value = k.guideB || '';
  document.getElementById('kariSignal').value = k.signal || '';
  document.getElementById('kariTransport').value = k.transport || '';
}

// ▼ まとめて再描画
function renderAll() {
  renderTablePave();
  renderEarthResult();
  renderDemoResult();
  renderAnzen();
  renderKari();
}

// ▼ DXFエクスポート
function exportDXF() {
  const list = allSites[currentSite]?.pave || [];
  let lines = [];
  let x = 0, y = 0;
  let scale = 100;
  let sumA = 0, sumC = 0, sumO = 0;
  for(let i=0;i<list.length;i++) {
    let r = list[i];
    let len = parseFloat(r.単距)||0;
    let width = parseFloat(r.幅員)||0;
    if(len<=0 || width<=0) continue;
    let x0 = x, y0 = y, x1 = x+len*scale, y1 = y+width*scale;
    lines.push(`0\nLINE\n8\n0\n10\n${x0}\n20\n${y0}\n11\n${x1}\n21\n${y0}\n`);
    lines.push(`0\nLINE\n8\n0\n10\n${x1}\n20\n${y0}\n11\n${x1}\n21\n${y1}\n`);
    lines.push(`0\nLINE\n8\n0\n10\n${x1}\n20\n${y1}\n11\n${x0}\n21\n${y1}\n`);
    lines.push(`0\nLINE\n8\n0\n10\n${x0}\n20\n${y1}\n11\n${x0}\n21\n${y0}\n`);
    lines.push(`0\nTEXT\n8\n0\n10\n${x+len*scale/2}\n20\n${y-18}\n40\n6\n1\n${len}\n`);
    if(r.種別==="アスファルト") sumA += parseFloat(r.面積)||0;
    if(r.種別==="コンクリート") sumC += parseFloat(r.面積)||0;
    if(r.種別==="オーバーレイ") sumO += parseFloat(r.面積)||0;
    x += len*scale;
  }
  let sumTextY = -38;
  if(sumA>0) { lines.push(`0\nTEXT\n8\n0\n10\n50\n20\n${sumTextY}\n40\n7\n1\nアスファルト舗装 合計A=${sumA.toFixed(1)}㎡\n`); sumTextY-=26; }
  if(sumC>0) { lines.push(`0\nTEXT\n8\n0\n10\n50\n20\n${sumTextY}\n40\n7\n1\nコンクリート舗装 合計A=${sumC.toFixed(1)}㎡\n`); sumTextY-=26; }
  if(sumO>0) { lines.push(`0\nTEXT\n8\n0\n10\n50\n20\n${sumTextY}\n40\n7\n1\nオーバーレイ舗装 合計A=${sumO.toFixed(1)}㎡\n`);}
  let dxf =
    '0\nSECTION\n2\nHEADER\n0\nENDSEC\n0\nSECTION\n2\nTABLES\n0\nENDSEC\n0\nSECTION\n2\nBLOCKS\n0\nENDSEC\n0\nSECTION\n2\nENTITIES\n'
    + lines.join('')
    + '0\nENDSEC\n0\nEOF\n';
  let blob = new Blob([dxf], {type:'text/plain'});
  let a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "pave.dxf";
  a.click();
}

// ▼ 全集計（従来形式）
function showSummary() {
  const tableStyle = "min-width:1200px;border-collapse:collapse;border:2px solid #555;background:#fff;width:auto;";
  const thStyle1 = "border:2px solid #555;background:#e6eef5;color:#007acc;font-weight:bold;text-align:center;padding:8px 5px;";
  const thStyle2 = "border:2px solid #555;background:#f7fbff;color:#007acc;font-weight:bold;text-align:center;padding:5px 5px;";
  const tdStyle = "border:2px solid #555;text-align:center;padding:6px 5px;";
  const dataCols = [
    "site",
    "machine_excavation", "residual_soil",
    "break_as", "haizan_unpan_as", "haizan_shori_as",
    "break_con", "haizan_unpan_con", "haizan_shori_con",
    "as_lt1_4", "as_ge1_4", "as_ge3_0",
    "ovl_lt1_4", "ovl_ge1_4", "ovl_ge3_0",
    "con_total",
    "std_as_curb", "small_as_curb", "hand_as_curb",
    "kakusen_out", "kakusen_stop", "kakusen_char",
    "kari_guard_b", "kari_signal", "kari_heavy",
    "zatsu_total"
    ];
  let html = `<div style="overflow-x:auto;"><table class="ss-table" style="${tableStyle}">`;
  html += `
<tr>
  <th rowspan="3" style="${thStyle1}">箇所名</th>
  <th colspan="2" style="${thStyle1}">土工</th>
  <th colspan="6" style="${thStyle1}">取り壊し工</th>
  <th colspan="10" style="${thStyle1}">舗装工</th>
  <th colspan="3" style="${thStyle1}">安全施設工</th>
  <th rowspan="3" style="${thStyle1}">交通誘導員B</th>
  <th rowspan="3" style="${thStyle1}">仮設信号機</th>
  <th rowspan="3" style="${thStyle1}">重機運搬費</th>
  <th rowspan="3" style="${thStyle1}">雑工</th>
</tr>
<tr>
  <th rowspan="2" style="${thStyle1}">機械掘削</th>
  <th rowspan="2" style="${thStyle1}">残土処理</th>
  <th rowspan="2" style="${thStyle1}">舗装版破砕As</th>
  <th rowspan="2" style="${thStyle1}">廃材運搬As</th>
  <th rowspan="2" style="${thStyle1}">廃材処理As</th>
  <th rowspan="2" style="${thStyle1}">舗装版破砕Con</th>
  <th rowspan="2" style="${thStyle1}">廃材運搬Con</th>
  <th rowspan="2" style="${thStyle1}">廃材処理Con</th>
  <th colspan="3" style="${thStyle1}">アスファルト</th>
  <th colspan="3" style="${thStyle1}">オーバーレイ</th>
  <th rowspan="2" style="${thStyle1}">コンクリート</th>
  <th rowspan="2" style="${thStyle1}">As縁石(標準)</th>
  <th rowspan="2" style="${thStyle1}">As縁石(小型)</th>
  <th rowspan="2" style="${thStyle1}">As縁石(手設置)</th>
  <th colspan="3" style="${thStyle1}">区画線設置</th>
</tr>
<tr>
  <th style="${thStyle2}">t=4cm 1.4未満</th>
  <th style="${thStyle2}">t=4cm 1.4以上</th>
  <th style="${thStyle2}">t=4cm 3.0以上</th>
  <th style="${thStyle2}">t=4cm 1.4未満</th>
  <th style="${thStyle2}">t=4cm 1.4以上</th>
  <th style="${thStyle2}">t=4cm 3.0以上</th>
  <th style="${thStyle2}">外側線</th>
  <th style="${thStyle2}">停止線</th>
  <th style="${thStyle2}">文字・記号</th>
</tr>`;

  let totalRow = {};
  dataCols.forEach(k => totalRow[k] = 0);
  totalRow.site = "総合計";

  Object.keys(allSites).forEach(site => {
    let row = {};
    row.site = site;

    let machine_excavation = 0, residual_soil = 0;
    let earthSetting = allSites[site].earthSetting || {};
    let paveSum = 0;
    (allSites[site].pave||[]).forEach(r=>paveSum+=parseFloat(r.面積)||0);
    if (earthSetting.same && document.getElementById('chkWorksEarth')?.checked) {
      let thick = parseFloat(earthSetting.thick)||0;
      machine_excavation = residual_soil = paveSum * thick / 100;
    }
    row.machine_excavation = machine_excavation > 0 ? machine_excavation.toFixed(2) : "";
    row.residual_soil = residual_soil > 0 ? residual_soil.toFixed(2) : "";

    let break_as = 0, break_con = 0;
    let haizan_unpan_as = 0, haizan_shori_as = 0, haizan_unpan_con = 0, haizan_shori_con = 0;
    let demoSetting = allSites[site].demoSetting || {};
    let demoType = demoSetting.type;
    let demoThick = parseFloat(demoSetting.thick)||0;
    if (demoSetting.same && document.getElementById('chkWorksDemo')?.checked) {
      if (demoType === "As") break_as = paveSum;
      else if (demoType === "Con") break_con = paveSum;
      else if (demoType === "As+Con") { break_as = paveSum; break_con = paveSum; }
      haizan_unpan_as = break_as * demoThick / 100;
      haizan_shori_as = haizan_unpan_as * 2.35;
      haizan_unpan_con = break_con * demoThick / 100;
      haizan_shori_con = haizan_unpan_con * 2.35;
    }
    row.break_as = break_as > 0 ? break_as.toFixed(1) : "";
    row.haizan_unpan_as = haizan_unpan_as > 0 ? haizan_unpan_as.toFixed(2) : "";
    row.haizan_shori_as = haizan_shori_as > 0 ? haizan_shori_as.toFixed(2) : "";
    row.break_con = break_con > 0 ? break_con.toFixed(1) : "";
    row.haizan_unpan_con = haizan_unpan_con > 0 ? haizan_unpan_con.toFixed(2) : "";
    row.haizan_shori_con = haizan_shori_con > 0 ? haizan_shori_con.toFixed(2) : "";

    let as_lt1_4 = 0, as_ge1_4 = 0, as_ge3_0 = 0,
        ovl_lt1_4 = 0, ovl_ge1_4 = 0, ovl_ge3_0 = 0, con_total = 0;

    (allSites[site].pave || []).forEach(r => {
      let area = parseFloat(r.面積) || 0;
      if (r.種別 === "アスファルト") {
        if (r.平均幅員 === "1.4未満") as_lt1_4 += area;
        else if (r.平均幅員 === "1.4以上") as_ge1_4 += area;
        else if (r.平均幅員 === "3.0以上") as_ge3_0 += area;
      } else if (r.種別 === "オーバーレイ") {
        if (r.平均幅員 === "1.4未満") ovl_lt1_4 += area;
        else if (r.平均幅員 === "1.4以上") ovl_ge1_4 += area;
        else if (r.平均幅員 === "3.0以上") ovl_ge3_0 += area;
      } else if (r.種別 === "コンクリート") {
        con_total += area;
      }
    });
    row.as_lt1_4 = as_lt1_4 > 0 ? as_lt1_4.toFixed(1) : "";
    row.as_ge1_4 = as_ge1_4 > 0 ? as_ge1_4.toFixed(1) : "";
    row.as_ge3_0 = as_ge3_0 > 0 ? as_ge3_0.toFixed(1) : "";
    row.ovl_lt1_4 = ovl_lt1_4 > 0 ? ovl_lt1_4.toFixed(1) : "";
    row.ovl_ge1_4 = ovl_ge1_4 > 0 ? ovl_ge1_4.toFixed(1) : "";
    row.ovl_ge3_0 = ovl_ge3_0 > 0 ? ovl_ge3_0.toFixed(1) : "";
    row.con_total = con_total > 0 ? con_total.toFixed(1) : "";

    // 追加の工種（現状計算対象なし）
    row.std_as_curb = "";
    row.small_as_curb = "";
    row.hand_as_curb = "";
    row.kakusen_out = "";
    row.kakusen_stop = "";
    row.kakusen_char = "";
    row.kari_guard_b = "";
    row.kari_signal = "";
    row.kari_heavy = "";
    const anzen = allSites[site].anzen || {};
    const kari = allSites[site].kari || {};
    let anzen_total = (parseFloat(anzen.outside)||0) + (parseFloat(anzen.stop)||0) + (parseFloat(anzen.mark)||0);
    let kari_total = (parseFloat(kari.guideB)||0) + (parseFloat(kari.signal)||0) + (parseFloat(kari.transport)||0);
    row.anzen_total = anzen_total > 0 ? anzen_total.toFixed(1) : "";
    row.kari_total = kari_total > 0 ? kari_total.toFixed(1) : "";
    row.zatsu_total = "";

    dataCols.forEach(k => {
      if (k !== "site") totalRow[k] += parseFloat(row[k]) || 0;
    });

    html += `<tr>${dataCols.map(k => `<td style="${tdStyle}">${row[k] || ""}</td>`).join("")}</tr>`;
  });

  html += `<tr style="background:#f3f9ff;font-weight:bold;">${
    dataCols.map(k =>
      `<td style="${tdStyle}">${k==="site" ? "総合計" : (totalRow[k] ? totalRow[k].toFixed(2) : "")}</td>`
    ).join("")
  }</tr>`;
  html += '</table></div>';
  document.getElementById('summary').innerHTML = html;
}

// ▼ 設定保存＋再描画
function saveAndUpdate() {
  if(currentSite && allSites[currentSite]) {
    allSites[currentSite].earthSetting = getEarthSetting();
    allSites[currentSite].demoSetting = getDemoSetting();
  }
  renderAllAndSave();
}

window.addEventListener('DOMContentLoaded', () => {
  loadCheckStates();
  migrateOldData();
  loadData();
  renderTabs();
  renderAll();
});
</script>
</body>
</html>
</html>
